<!--newsfeed/templates/newsfeed/home.html-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommuDev Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Optional Theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">   
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .feed-container {
            height: calc(100vh - 64px);
            margin-top: 64px;
        }

        .sidebar {
            width: 400px;
            height: calc(100vh - 64px);
            overflow-y: auto;
        }

        .special-date {
          background-color: #e2f0ff !important;
          border-radius: 50%;
          
        }

        .event-dot {
          position: absolute;
          bottom: 3px;
          left: 50%;
          transform: translateX(-50%);
          width: 4px;
          height: 4px;
          background-color: #FF0400;
          border-radius: 50%;
        }
  
        .flatpickr-day {
          position: relative;
        }

        .main-content {
            width: calc(100% - 800px);
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md fixed top-0 w-full z-50 h-16">
        <div class="w-full px-4 flex justify-between items-center h-full">
            <div class="flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900">CommuDev</h1>
            </div>
            <div class="flex items-center space-x-6">
                <a href="{% url 'home' %}" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-home text-xl"></i>
                </a>
                <a href="{% url 'resource_home' %}" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-book text-xl"></i>
                </a>
                <!-- New navigation items -->
                <a href="{% url 'chat_home' %}" class="text-gray-600 hover:text-gray-900 relative">
                    <i class="fas fa-comments text-xl"></i>
                    <span id="nav-unread-count" 
                          class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full text-white text-xs flex items-center justify-center hidden">
                    </span>
                </a>
                <a href="#" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-tasks text-xl"></i>
                </a>
                <a href="#" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-gift text-xl"></i>
                </a>
                <a href="#" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-comment-dots text-xl"></i>
                </a>
                <a href="{% url 'profile' %}" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-user-circle text-xl"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="feed-container flex">
        <!-- Left Sidebar -->
        <div class="sidebar bg-gray-100 p-4 custom-scrollbar">
            <!-- Communities -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <h2 class="font-bold text-xl mb-4">Communities</h2>
                <ul class="space-y-3">
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg transition duration-150">
                            <i class="fas fa-building text-blue-500"></i>
                            <span class="text-gray-700">Municipal Community</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg transition duration-150">
                            <i class="fas fa-home text-green-500"></i>
                            <span class="text-gray-700">Barangay Community</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Friends -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-bold text-xl mb-4">Friends</h2>
                <ul class="space-y-4">
                    <li class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                        <span class="text-gray-700">Friend 1</span>
                    </li>
                    <li class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                        <span class="text-gray-700">Friend 2</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Feed -->
        <div class="main-content bg-gray-100 custom-scrollbar overflow-y-auto">
            <div class="space-y-4 p-4">
                <!-- Create Post Button -->
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <div class="flex space-x-3 cursor-pointer" onclick="openCreateModal()">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-gray-500 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="w-full px-4 py-3 bg-gray-100 rounded-lg text-gray-500">
                                What's on your mind?
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posts Feed -->
                {% for post in newsfeeds %}
                <article class="bg-white rounded-lg shadow">
                    <!-- Post Header -->
                    <div class="p-4 flex items-center justify-between border-b">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-gray-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">{{ post.created_by.firstname }} {{ post.created_by.lastname }}</p>
                                <p class="text-sm text-gray-500">{{ post.post_date|date:"F j, Y" }}</p>
                            </div>
                        </div>
                        {% if post.created_by == user %}
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div x-show="open" @click.away="open = false" 
                                 class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1">
                                <button onclick="editPost('{{ post.feed_id }}')" 
                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-edit mr-2"></i> Edit
                                </button>
                                <button onclick="deletePost('{{ post.feed_id }}')" 
                                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                    <i class="fas fa-trash mr-2"></i> Delete
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Post Content -->
                    <div class="pb-4">
                        <p class="text-gray-800 whitespace-pre-line ml-6 mt-0" data-post-id="{{ post.feed_id }}">
                            {{ post.post_description }}
                        </p>
                        {% if post.image %}
                        <div class="mt-3 ml-0"> <!-- Same margin-left as post description -->
                            <img src="{{ post.image.url }}" alt="Post image" class="w-full h-auto">
                        </div>
                        {% endif %}
                    </div>

                    <!-- Post Actions -->
                    <div class="px-4 py-3 border-t">
                        <form id="like-form-{{ post.feed_id }}" class="like-form flex items-center">
                        {% csrf_token %}
                        <button type="button" 
                                data-post-id="{{ post.feed_id }}" 
                                class="like-button flex items-center space-x-2 
                                      {% if request.user in post.likes.all %}text-red-500{% else %}text-gray-500{% endif %} 
                                      hover:text-red-500">
                            <i class="fas fa-heart"></i>
                            <span class="like-count">{{ post.like_count }}</span>
                        </button>
                    </form>
                    </div>
                </article>
                {% empty %}
                <div class="text-center py-8 bg-white rounded-lg shadow">
                    <p class="text-gray-500">No posts yet. Be the first to share something!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar bg-gray-100 p-4 custom-scrollbar">
          <!-- Calendar -->
          <div class="bg-white rounded-lg shadow p-4 mb-4">
              <div class="flex justify-between items-center mb-4">
                  <h2 class="font-bold text-xl">Calendar</h2>
                  <button onclick="openCreateEventModal()" class="text-blue-500 hover:text-blue-700">
                      <i class="fas fa-plus-circle text-xl"></i>
                  </button>
              </div>
              <div class="flex justify-center bg-gray-50 rounded-lg">
                  <input type="text" id="calendar" class="hidden">
              </div>
          </div>
      

            <!-- Notifications -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-bold text-xl mb-4">Notifications</h2>
                <div class="space-y-4">
                    <div class="p-3 hover:bg-gray-50 rounded-lg transition duration-150">
                        <p class="text-gray-800">New like on your post</p>
                        <p class="text-sm text-gray-500 mt-1">2 hours ago</p>
                    </div>
                    <div class="p-3 hover:bg-gray-50 rounded-lg transition duration-150">
                        <p class="text-gray-800">Someone commented on your post</p>
                        <p class="text-sm text-gray-500 mt-1">5 hours ago</p>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Create Post</h3>
                <button onclick="closeCreateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form method="POST" enctype="multipart/form-data" id="createPostForm" class="p-4">
                {% csrf_token %}
                <div class="space-y-4">
                    <!-- Post Content -->
                    <textarea name="post_description" 
                              class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              rows="4" 
                              placeholder="What's on your mind?"></textarea>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="hidden">
                        <img id="preview" class="max-h-64 rounded-lg mx-auto">
                        <button type="button" onclick="removeImage()" class="mt-2 text-red-500 hover:text-red-700">
                            Remove Image
                        </button>
                    </div>

                    <!-- Upload Controls -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="post-image" class="cursor-pointer flex items-center space-x-2 text-blue-500 hover:text-blue-700">
                                <i class="fas fa-image"></i>
                                <span>Add Photo</span>
                            </label>
                            <input type="file" 
                                   id="post-image" 
                                   name="image" 
                                   accept="image/*" 
                                   class="hidden" 
                                   onchange="previewImage(event)">
                        </div>
                        <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Post
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Edit Post</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
              <textarea id="editContent" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4"></textarea>
            </div>
            <div class="p-4 border-t flex justify-end space-x-3">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    Cancel
                </button>
                <button id="saveEdit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-md mx-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Delete Post</h3>
                <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="text-gray-600">Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t flex justify-end space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    Cancel
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
<div id="createEventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg w-full max-w-md mx-4">
      <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-xl font-semibold text-gray-900">Create Event</h3>
          <button onclick="closeCreateEventModal()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
          </button>
      </div>
      <form id="createEventForm" class="p-4">
        {% csrf_token %}
          <div class="space-y-4">
              <div>
                  <label class="block text-sm font-medium text-gray-700">Event Title</label>
                  <input type="text" id="eventTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">

              </div>
              <div>
                  <label class="block text-sm font-medium text-gray-700">Start Date</label>
                  <input type="date" id="eventDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">End Date</label>
                <input type="date" id="eventEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
              <div>
                  <label class="block text-sm font-medium text-gray-700">Start Time</label>
                  <input type="time" id="eventTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">End Time</label>
                <input type="time" id="eventEndTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
              <div>
                  <label class="block text-sm font-medium text-gray-700">Description</label>
                  <textarea id="eventDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm ring-2 ring-green-500 p-2"></textarea>

              </div>
          </div>
          <div class="mt-5 flex justify-end space-x-3">
              <button type="button" onclick="closeCreateEventModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                  Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  Create Event
              </button>
          </div>
      </form>
  </div>
</div>

    <!-- View Events Modal -->
    <div id="viewEventsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg w-full max-w-md mx-4">
          <div class="p-4 border-b flex justify-between items-center">
              <h3 class="text-xl font-semibold text-gray-900">Events for <span id="selectedDate"></span></h3>
              <button onclick="closeViewEventsModal()" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          <div class="p-4">
              <div id="eventsList" class="space-y-3">
                  <!-- Events will be dynamically inserted here -->
              </div>
          </div>
          <div class="p-4 border-t flex justify-end">
              <button onclick="closeViewEventsModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                  Close
              </button>
          </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      let currentPostId = null;

      function editPost(postId) {
        currentPostId = postId;
        const content = document
          .querySelector(`[data-post-id="${postId}"]`)
          .textContent.trim();
        document.getElementById("editContent").value = content;
        document.getElementById("editModal").classList.remove("hidden");
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
      }

      function deletePost(postId) {
        currentPostId = postId;
        document.getElementById("deleteModal").classList.remove("hidden");
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
      }

      document
        .getElementById("saveEdit")
        .addEventListener("click", function () {
          const content = document.getElementById("editContent").value;
          fetch(`/news/update/${currentPostId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
            body: JSON.stringify({
              post_description: content,
            }),
          }).then((response) => {
            if (response.ok) {
              window.location.reload();
            }
          });
        });

      document
        .getElementById("confirmDelete")
        .addEventListener("click", function () {
          fetch(`/news/delete/${currentPostId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
          }).then((response) => {
            if (response.ok) {
              window.location.reload();
            }
          });
        });

      // Close modals when clicking outside
      window.addEventListener("click", function (event) {
        const editModal = document.getElementById("editModal");
        const deleteModal = document.getElementById("deleteModal");

        if (event.target === editModal) {
          closeEditModal();
        }
        if (event.target === deleteModal) {
          closeDeleteModal();
        }
      });

      // Handle escape key to close modals
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeEditModal();
          closeDeleteModal();
        }
      });

      // Prevent scroll on body when modal is open
      function toggleBodyScroll(disable) {
        document.body.style.overflow = disable ? "hidden" : "";
      }

      // Update modal open/close functions to handle scroll
      const originalCloseEditModal = closeEditModal;
      const originalCloseDeleteModal = closeDeleteModal;

      closeEditModal = function () {
        originalCloseEditModal();
        toggleBodyScroll(false);
      };

      closeDeleteModal = function () {
        originalCloseDeleteModal();
        toggleBodyScroll(false);
      };

      editPost = function (postId) {
        currentPostId = postId;
        const content = document
          .querySelector(`[data-post-id="${postId}"]`)
          .textContent.trim();
        document.getElementById("editContent").value = content;
        document.getElementById("editModal").classList.remove("hidden");
        toggleBodyScroll(true);
      };

      deletePost = function (postId) {
        currentPostId = postId;
        document.getElementById("deleteModal").classList.remove("hidden");
        toggleBodyScroll(true);
      };

      function openCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
        toggleBodyScroll(true);
    }
    
    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        toggleBodyScroll(false);
        // Reset form
        document.getElementById('createPostForm').reset();
        document.getElementById('imagePreview').classList.add('hidden');
    }
    
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('preview');
                preview.src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }
    }
    
    function removeImage() {
        document.getElementById('post-image').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const likeButtons = document.querySelectorAll(".like-button");

        likeButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const postId = this.getAttribute("data-post-id");
            const csrfToken = document.querySelector(
              "[name=csrfmiddlewaretoken]"
            ).value;

            fetch(`/news/like/${postId}/`, {
              // Note the 'news/' prefix
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                // Check if the response is OK
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                // Check the status in the response
                if (data.status === "success") {
                  // Update like count and button style
                  const likeCountElement = this.querySelector(".like-count");
                  likeCountElement.textContent = data.like_count;

                  if (data.liked) {
                    this.classList.remove("text-gray-500");
                    this.classList.add("text-red-500");
                  } else {
                    this.classList.remove("text-red-500");
                    this.classList.add("text-gray-500");
                  }
                } else {
                  console.error("Like action failed:", data.message);
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                alert(
                  "An error occurred while processing your like/unlike action"
                );
              });
          });
        });
      });
    </script>

    <script>
        //CALENDAR
        let events = [];
            // Initialize calendar
            const calendar = flatpickr("#calendar", {
                inline: true,
                dateFormat: "Y-m-d",
                defaultDate: "today",
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    showEventsForDate(dateStr);
                },
                onMonthChange: function(selectedDates, dateStr, instance) {
                    updateCalendarDots();
                },
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const dateStr = flatpickr.formatDate(dayElem.dateObj, "Y-m-d");
                    if (hasEventsOnDate(dateStr)) {
                        dayElem.innerHTML += '<span class="event-dot"></span>';
                    }
                }
            });

            function initializeCalendar() {
                if (calendar) {
                    calendar.destroy();
                }
                flatpickr("#calendar", {
                    inline: true,
                    dateFormat: "Y-m-d",
                    defaultDate: "today",
                    disableMobile: true,
                    onChange: function(selectedDates, dateStr, instance) {
                        showEventsForDate(dateStr);
                    },
                    onMonthChange: function(selectedDates, dateStr, instance) {
                        updateCalendarDots();
                    },
                    onDayCreate: function(dObj, dStr, fp, dayElem) {
                        const dateStr = flatpickr.formatDate(dayElem.dateObj, "Y-m-d");
                        if (hasEventsOnDate(dateStr)) {
                            dayElem.innerHTML += '<span class="event-dot"></span>';
                        }
                    }
                });
                updateCalendarDots();
            }

            // Load events when page loads
            function loadEvents() {
                console.log('Loading events...');
                fetch('/calendar/get/')
                    .then(response => {
                        console.log('Response received:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Events data:', data);
                        events = data.events || [];
                        updateCalendarDots();
                    })
                    .catch(error => console.error('Error loading events:', error));
            }

            // Call loadEvents when page loads
            document.addEventListener('DOMContentLoaded', loadEvents);

            function openCreateEventModal() {
                document.getElementById('createEventModal').classList.remove('hidden');
                document.getElementById('eventDate').value = flatpickr.formatDate(new Date(), "Y-m-d");
            }

            function closeCreateEventModal() {
                document.getElementById('createEventModal').classList.add('hidden');
                document.getElementById('createEventForm').reset();
            }

            function closeViewEventsModal() {
                document.getElementById('viewEventsModal').classList.add('hidden');
            }

           // Create event form submission
            document.getElementById('createEventForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Format the time properly
                const time = document.getElementById('eventTime').value || '00:00';
                
                const eventData = {
                    title: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    date: document.getElementById('eventDate').value,
                    end_date: document.getElementById('eventEndDate').value,
                    time: document.getElementById('eventTime').value || '00:00',
                    end_time: document.getElementById('eventEndTime').value || '23:59'
                };

                console.log('Sending event data:', eventData);

                fetch('/calendar/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(eventData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Server response:', data);
                    if (data.status === 'success') {
                        events.push(data.event);
                        // Instead of reassigning calendar, just reinitialize it
                        initializeCalendar();
                        closeCreateEventModal();
                        document.getElementById('createEventForm').reset();
                    }
                })
                .catch(error => {
                    console.error('Error creating event:', error);
                    alert('Failed to create event. Please try again.');
                });
            });

            function hasEventsOnDate(dateStr) {
                return events.some(event => event.date === dateStr);
            }

            function updateCalendarDots() {
                console.log('Updating calendar dots with events:', events);
                const days = document.querySelectorAll('.flatpickr-day');
                days.forEach(day => {
                    const dateStr = flatpickr.formatDate(new Date(day.dateObj), "Y-m-d");
                    console.log('Checking date:', dateStr);
                    if (hasEventsOnDate(dateStr)) {
                        if (!day.querySelector('.event-dot')) {
                            day.innerHTML += '<span class="event-dot"></span>';
                        }
                    }
                });
            }

            function showEventsForDate(dateStr) {
                const dateEvents = events.filter(event => event.date === dateStr);
                if (dateEvents && dateEvents.length > 0) {
                    const eventsList = document.getElementById('eventsList');
                    eventsList.innerHTML = dateEvents.map(event => `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${event.title}</div>
                                    <div class="text-sm text-gray-600">
                                        ${formatTime(event.time)} ${event.end_time ? ' - ' + formatTime(event.end_time) : ''}
                                    </div>
                                    ${event.end_date ? `
                                    <div class="text-sm text-gray-600">
                                        Until ${formatDate(event.end_date)}
                                    </div>
                                    ` : ''}
                                    <div class="text-sm mt-1">${event.description}</div>
                                </div>
                                <button onclick="deleteEvent(${event.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('selectedDate').textContent = flatpickr.formatDate(new Date(dateStr), "F j, Y");
                    document.getElementById('viewEventsModal').classList.remove('hidden');
                }
            }

            function formatDate(dateStr) {
                return new Date(dateStr).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }

            function formatTime(timeStr) {
                if (!timeStr) return 'No time set';
                try {
                    const [hours, minutes] = timeStr.split(':');
                    const date = new Date();
                    date.setHours(parseInt(hours), parseInt(minutes));
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return timeStr;
                }
            }

            function deleteEvent(eventId) {
                if (confirm('Are you sure you want to delete this event?')) {
                    fetch(`/calendar/delete/${eventId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            events = events.filter(event => event.id !== eventId);
                            initializeCalendar();
                            const currentDate = flatpickr.formatDate(new Date(), "Y-m-d");
                            showEventsForDate(currentDate);
                            closeViewEventsModal();
                        }
                    })
                    .catch(error => console.error('Error deleting event:', error));
                }
            }
    </script>

    <script>
        function updateNavUnreadCount() {
            fetch('/chat/unread-count/')
                .then(response => response.json())
                .then(data => {
                    const unreadBadge = document.getElementById('nav-unread-count');
                    if (unreadBadge) {  // Check if element exists
                        if (data.unread_count > 0) {
                            unreadBadge.textContent = data.unread_count;
                            unreadBadge.classList.remove('hidden');
                        } else {
                            unreadBadge.classList.add('hidden');
                        }
                    }
                })
                .catch(error => console.error('Error updating unread count:', error));
        }
    
        // Update unread count every 5 seconds
        function startUnreadCountPolling() {
            updateNavUnreadCount(); // Initial update
            setInterval(updateNavUnreadCount, 5000);
        }
    
        // Start polling when document is ready
        document.addEventListener('DOMContentLoaded', startUnreadCountPolling);
    </script>

 

  </body>
</html>
