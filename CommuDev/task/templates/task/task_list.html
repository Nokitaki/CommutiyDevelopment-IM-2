<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommuDev Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .task-container {
            height: calc(100vh - 64px);
            margin-top: 64px;
        }

        .task-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100">
    {% csrf_token %}
    <!-- Navigation -->
    <nav class="bg-white shadow-md fixed top-0 w-full z-50 h-16">
        <div class="w-full px-4 flex justify-between items-center h-full">
            <div class="flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900">CommuDev</h1>
            </div>
            <div class="flex items-center space-x-8">
                <a href="{% url 'home' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">Home</span>
                </a>
                <a href="{% url 'resource_home' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-book text-xl"></i>
                    <span class="text-xs mt-1">Resources</span>
                </a>
                <a href="{% url 'chat_home' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center relative">
                    <i class="fas fa-comments text-xl"></i>
                    <span class="text-xs mt-1">Chat</span>
                    <span id="nav-unread-count" class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full text-white text-xs flex items-center justify-center hidden"></span>
                </a>
                <a href="{% url 'task:task_list' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-tasks text-xl"></i>
                    <span class="text-xs mt-1">Tasks</span>
                </a>
                <a href="{% url 'reward-list' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-gift text-xl"></i>
                    <span class="text-xs mt-1">Rewards</span>
                </a>
                <a href="{% url 'feedback:feedback-list' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-flag text-xl"></i>
                    <span class="text-xs mt-1">Feedbacks</span>
                </a>
                <a href="{% url 'profile' %}" class="text-gray-600 hover:text-gray-900 flex flex-col items-center">
                    <i class="fas fa-user-circle text-xl"></i>
                    <span class="text-xs mt-1">Profile</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="task-container flex">
        <!-- Left Sidebar -->
        <div class="w-1/6 bg-white p-4 shadow-md">
            <h2 class="text-xl font-bold mb-4">Task Categories</h2>
            <ul class="space-y-2">
                <li>
                    <a href="{% url 'task:task_list' %}?filter=all" 
                       class="flex items-center p-2 hover:bg-gray-100 rounded-lg {% if not request.GET.filter or request.GET.filter == 'all' %}bg-gray-100{% endif %}">
                        <i class="fas fa-tasks mr-3 text-blue-500"></i>
                        All Tasks
                    </a>
                </li>
                <li>
                    <a href="{% url 'task:task_list' %}?filter=assigned" 
                       class="flex items-center p-2 hover:bg-gray-100 rounded-lg {% if request.GET.filter == 'assigned' %}bg-gray-100{% endif %}">
                        <i class="fas fa-user-check mr-3 text-green-500"></i>
                        My Tasks
                    </a>
                </li>
                <li>
                    <a href="{% url 'task:task_list' %}?filter=available" 
                       class="flex items-center p-2 hover:bg-gray-100 rounded-lg {% if request.GET.filter == 'available' %}bg-gray-100{% endif %}">
                        <i class="fas fa-calendar-plus mr-3 text-purple-500"></i>
                        Available Events
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
            {% if user.is_staff %}
            <div class="mb-6">
                <button onclick="openCreateTaskModal()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Create New Task/Event
                </button>
            </div>
            {% endif %}

            <!-- Tasks Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for task in tasks %}
                <div class="task-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transform transition-all duration-300">
                    <div class="p-6">
                        <!-- Header Section -->
                        <div class="flex justify-between items-start mb-5">
                            <div class="flex-grow">
                                <h3 class="text-xl font-semibold text-gray-800 mb-1 line-clamp-1">{{ task.title }}</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-semibold">{{ task.created_by.firstname.0 }}</span>
                                    </div>
                                    <p class="text-sm text-gray-600">{{ task.created_by.firstname }} {{ task.created_by.lastname }}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="px-3 py-1 rounded-full text-sm font-medium 
                                    {% if task.priority == 'HIGH' %}bg-red-100 text-red-800
                                    {% elif task.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ task.priority }}
                                </span>
                                {% if task.reward_points > 0 %}
                                <div class="flex items-center bg-purple-100 px-3 py-1 rounded-full">
                                    <i class="fas fa-gift text-purple-600 mr-2"></i>
                                    <span class="text-sm font-medium text-purple-800">{{ task.reward_points }} Points</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Description Section -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 h-24 overflow-hidden">
                            <p class="text-gray-700 break-words overflow-ellipsis text-sm">
                                {{ task.description|truncatechars:150 }}
                                {% if task.description|length > 150 %}
                                    <span class="text-blue-500 font-medium">...</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Details Section -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <div class="flex items-center text-sm text-gray-700">
                                    <i class="far fa-calendar mr-2 text-blue-600"></i>
                                    <span>{{ task.due_date|date:"F j, Y" }}</span>
                                </div>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-3">
                                <div class="flex items-center text-sm text-gray-700">
                                    <i class="far fa-clock mr-2 text-blue-600"></i>
                                    <span>{{ task.due_date|date:"g:i A" }}</span>
                                </div>
                            </div>
                        </div>
            
                        <!-- Spacer for non-event tasks -->
                        {% if not task.is_event %}
                        <div class="mb-4">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center text-sm text-gray-700">
                                    <i class="fas fa-tasks mr-2 text-gray-600"></i>
                                    <span>Regular Task</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
            
                        <!-- Event Participants Section -->
                        {% if task.is_event %}
                        <div class="bg-indigo-50 rounded-lg p-3 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-sm text-gray-700">
                                    <i class="fas fa-users mr-2 text-indigo-600"></i>
                                    <span>Participants: {{ task.assigned_to.count }}
                                    {% if task.max_participants > 0 %}
                                    / {{ task.max_participants }}
                                    {% endif %}</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="flex -space-x-2">
                                        {% for participant in task.assigned_to.all|slice:":3" %}
                                        <div class="w-7 h-7 rounded-full bg-white border-2 border-indigo-50 flex items-center justify-center">
                                            <span class="text-xs font-medium text-indigo-600">{{ participant.firstname.0 }}</span>
                                        </div>
                                        {% endfor %}
                                        {% if task.assigned_to.count > 3 %}
                                        <div class="w-7 h-7 rounded-full bg-indigo-100 border-2 border-indigo-50 flex items-center justify-center">
                                            <span class="text-xs font-medium text-indigo-600">+{{ task.assigned_to.count|add:"-3" }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
            
                        <!-- Footer Section -->
                        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                            <span class="px-3 py-1 rounded-full text-sm font-medium 
                                {% if task.status == 'COMPLETED' %}bg-green-100 text-green-800
                                {% elif task.status == 'IN_PROGRESS' %}bg-blue-100 text-blue-800
                                {% elif task.status == 'CANCELLED' %}bg-gray-100 text-gray-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ task.status }}
                            </span>
            
                            <div class="flex gap-2">
                                {% if task.is_event and user not in task.assigned_to.all %}
                                <button onclick="joinTask({{ task.task_id }})"
                                        class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:shadow transition-all duration-200">
                                    <i class="fas fa-user-plus mr-2"></i>Join Event
                                </button>
                                {% elif task.is_event %}
                                <button onclick="leaveTask({{ task.task_id }})"
                                        class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:shadow transition-all duration-200">
                                    <i class="fas fa-user-minus mr-2"></i>Leave Event
                                </button>
                                {% endif %}
                                <button onclick="openTaskDetail({{ task.task_id }})" 
                                        class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:shadow transition-all duration-200">
                                    <i class="fas fa-eye mr-2"></i>View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-2 text-center py-12 bg-white rounded-xl shadow-md">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 text-lg">No tasks or events available at the moment.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="w-1/5 bg-white p-4 shadow-md">
            <h2 class="text-xl font-bold mb-4">Task Statistics</h2>
            <div class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700">My Tasks</h3>
                    <div class="mt-2 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Pending</span>
                            <span class="font-semibold">{{ pending_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">In Progress</span>
                            <span class="font-semibold">{{ in_progress_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Completed</span>
                            <span class="font-semibold">{{ completed_count }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700">Upcoming Events</h3>
                    <div class="mt-2 space-y-3">
                        {% for event in upcoming_events %}
                        <div class="text-sm">
                            <div class="font-semibold text-gray-800">{{ event.title }}</div>
                            <div class="text-gray-600">{{ event.due_date|date:"F j, Y" }}</div>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500">No upcoming events</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto py-10">
    <div class="bg-white rounded-xl w-full max-w-5xl mx-4 shadow-2xl transform transition-all">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-t-xl">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-plus-circle mr-3"></i>
                    Create New Task/Event
                </h3>
                <button onclick="closeCreateTaskModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Form -->
        <form method="POST" action="{% url 'task:create_task' %}" class="p-6">
            {% csrf_token %}
            
            <div class="grid grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Title and Description -->
                    <div class="bg-gray-50 p-6 rounded-xl space-y-6">
                        <div>
                            <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-heading mr-2 text-blue-500"></i>Title *
                            </label>
                            <input type="text" name="title" id="title" required
                                   class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-align-left mr-2 text-blue-500"></i>Description *
                            </label>
                            <textarea name="description" id="description" rows="3" required
                                      class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm p-3"></textarea>
                        </div>
                    </div>

                    <!-- Date and Time -->
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="due_date" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="far fa-calendar mr-2 text-blue-500"></i>Due Date *
                                </label>
                                <input type="date" name="due_date" id="due_date" required
                                       class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm">
                            </div>
                            <div>
                                <label for="due_time" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="far fa-clock mr-2 text-blue-500"></i>Due Time *
                                </label>
                                <input type="time" name="due_time" id="due_time" required
                                       class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Priority and Points -->
                    <div class="bg-gray-50 p-6 rounded-xl space-y-6">
                        <div>
                            <label for="priority" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-flag mr-2 text-blue-500"></i>Priority *
                            </label>
                            <select name="priority" id="priority" required
                                    class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm">
                                <option value="LOW">Low Priority</option>
                                <option value="MEDIUM" selected>Medium Priority</option>
                                <option value="HIGH">High Priority</option>
                            </select>
                        </div>

                        <div>
                            <label for="reward_points" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-gift mr-2 text-blue-500"></i>Reward Points
                            </label>
                            <div class="relative">
                                <input type="number" name="reward_points" id="reward_points" min="0" value="0"
                                       class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm p-3">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">points</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event Toggle and Details -->
                    <div class="bg-gray-50 p-6 rounded-xl space-y-6">
                        <div class="flex items-center">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="is_event" id="is_event" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-3 text-sm font-semibold text-gray-700">This is an event</span>
                            </label>
                        </div>

                        <div id="eventFields" class="hidden grid grid-cols-2 gap-4">
                            <div>
                                <label for="location" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>Location
                                </label>
                                <input type="text" name="location" id="location"
                                       class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm">
                            </div>
                            <div>
                                <label for="max_participants" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-users mr-2 text-blue-500"></i>Max Participants
                                </label>
                                <input type="number" name="max_participants" id="max_participants" value="0" min="0"
                                       class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm"
                                       placeholder="0 for unlimited">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button type="button" onclick="closeCreateTaskModal()"
                        class="px-6 py-2.5 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200 flex items-center">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2.5 text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg transition-all duration-200 flex items-center shadow-md hover:shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i>Create Task/Event
                </button>
            </div>
        </form>
    </div>
</div>
 
    <!-- Task Detail Modal -->
<div id="taskDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6">
            <div class="flex justify-between items-center">
                <h3 id="detailTaskTitle" class="text-xl font-semibold text-white"></h3>
                <button onclick="closeTaskDetailModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto">
            <!-- Creator Info Card -->
            <div class="bg-gray-50 rounded-xl p-6 mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                        <span id="detailCreatorInitial" class="text-white text-lg font-semibold"></span>
                    </div>
                    <div class="ml-4">
                        <p id="detailCreatorName" class="text-gray-800 font-semibold"></p>
                        <p id="detailCreatedDate" class="text-sm text-gray-500"></p>
                    </div>
                </div>
            </div>

            <!-- Status and Priority -->
            <div class="flex gap-4 mb-6">
                <span id="detailStatus" class="px-4 py-2 rounded-full text-sm font-medium"></span>
                <span id="detailPriority" class="px-4 py-2 rounded-full text-sm font-medium"></span>
            </div>

            <!-- Main Info Card -->
            <div class="bg-gray-50 rounded-xl p-6 space-y-6 mb-6">
                <!-- Description -->
                <div>
                    <h4 class="text-gray-700 font-semibold mb-3 flex items-center">
                        <i class="fas fa-align-left mr-2 text-blue-500"></i>Description
                    </h4>
                    <p id="detailDescription" class="text-gray-600 bg-white p-4 rounded-lg whitespace-pre-wrap break-words"></p>
                </div>

                <!-- Reward Points -->
                <div>
                    <h4 class="text-gray-700 font-semibold mb-3 flex items-center">
                        <i class="fas fa-gift mr-2 text-blue-500"></i>Reward Points
                    </h4>
                    <div class="flex items-center text-gray-600 bg-white p-4 rounded-lg">
                        <span id="detailRewardPoints"></span>
                    </div>
                </div>

                <!-- Due Date -->
                <div>
                    <h4 class="text-gray-700 font-semibold mb-3 flex items-center">
                        <i class="far fa-calendar mr-2 text-blue-500"></i>Due Date
                    </h4>
                    <div class="flex items-center text-gray-600 bg-white p-4 rounded-lg">
                        <span id="detailDueDate"></span>
                    </div>
                </div>
            </div>

            <!-- Event Details Card -->
            <div id="detailEventSection" class="hidden bg-gray-50 rounded-xl p-6 space-y-4 mb-6">
                <h4 class="text-gray-700 font-semibold flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Event Details
                </h4>
                <div class="space-y-4">
                    <div class="flex items-center text-gray-600 bg-white p-4 rounded-lg">
                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                        <span id="detailLocation"></span>
                    </div>
                    <div class="flex items-center text-gray-600 bg-white p-4 rounded-lg">
                        <i class="fas fa-users mr-2 text-blue-500"></i>
                        <span id="detailParticipants"></span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 mt-6 pt-6 border-t">
                <div id="detailEventButtons" class="hidden">
                    <!-- Join/Leave buttons will be inserted here by JavaScript -->
                </div>
                {% if user.is_staff %}
                <button id="detailEditButton" onclick="editTask(currentTaskId)" 
                        class="px-6 py-2.5 text-blue-600 hover:bg-blue-50 rounded-lg flex items-center transition-colors">
                    <i class="fas fa-edit mr-2"></i>Edit Task
                </button>
                <button id="detailDeleteButton" onclick="deleteTask(currentTaskId)"
                        class="px-6 py-2.5 text-red-600 hover:bg-red-50 rounded-lg flex items-center transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>Delete Task
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <script>
        // Add this function at the top
        function getCsrfToken() {
            const cookieName = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, cookieName.length + 1) === (cookieName + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(cookieName.length + 1));
                        break;
                    }
                }
            }
            return cookieValue || document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    
    </script>

    <script>

        
      

        // Close modal when clicking outside
        document.getElementById('createTaskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateTaskModal();
            }
        });

        // Update task status
        function updateTaskStatus(taskId, status) {
            fetch(`/task/${taskId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error updating task status. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating task status. Please try again.');
            });
        }

        // Update assignment status
        function updateAssignmentStatus(taskId, status) {
            fetch(`/task/${taskId}/update-assignment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error updating assignment status. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating assignment status. Please try again.');
            });
        }

        // Handle event checkbox toggle
        document.addEventListener('DOMContentLoaded', function() {
            const isEventCheckbox = document.getElementById('id_is_event');
            const locationField = document.querySelector('[name="location"]').closest('.space-y-2');
            const maxParticipantsField = document.querySelector('[name="max_participants"]').closest('.space-y-2');

            function toggleEventFields() {
                if (isEventCheckbox.checked) {
                    locationField.style.display = 'block';
                    maxParticipantsField.style.display = 'block';
                } else {
                    locationField.style.display = 'none';
                    maxParticipantsField.style.display = 'none';
                }
            }

            if (isEventCheckbox) {
                toggleEventFields(); // Initial state
                isEventCheckbox.addEventListener('change', toggleEventFields);
            }
        });

        // Message handling
        {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
            showNotification("{{ message }}", "{{ message.tags }}");
            {% endfor %}
        });
        {% endif %}

       
        // Update unread count (same as in ResourceHub)
        function updateNavUnreadCount() {
            fetch('/chat/unread-count/')
                .then(response => response.json())
                .then(data => {
                    const unreadBadge = document.getElementById('nav-unread-count');
                    if (unreadBadge) {
                        if (data.unread_count > 0) {
                            unreadBadge.textContent = data.unread_count;
                            unreadBadge.classList.remove('hidden');
                        } else {
                            unreadBadge.classList.add('hidden');
                        }
                    }
                })
                .catch(error => console.error('Error updating unread count:', error));
        }
        
        // Start polling when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateNavUnreadCount(); // Initial update
            setInterval(updateNavUnreadCount, 5000);
        });
    </script>

    <script>
        function openCreateTaskModal() {
            document.getElementById('createTaskModal').classList.remove('hidden');
            // Set default date and time
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Format date as YYYY-MM-DD
            const formattedDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('due_date').value = formattedDate;
            
            // Set default time to 12:00
            document.getElementById('due_time').value = '12:00';
        }
    
        function closeCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('hidden');
            // Reset form
            document.querySelector('#createTaskModal form').reset();
        }
    
         // Handle event checkbox toggle
    document.addEventListener('DOMContentLoaded', function() {
        const isEventCheckbox = document.getElementById('is_event');
        const eventFields = document.getElementById('eventFields');

        function toggleEventFields() {
            eventFields.classList.toggle('hidden', !isEventCheckbox.checked);
        }

        isEventCheckbox.addEventListener('change', toggleEventFields);

        // Form submission handling
        const form = document.querySelector('#createTaskModal form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Combine date and time
            const date = document.getElementById('due_date').value;
            const time = document.getElementById('due_time').value;
            
            if (!date || !time) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Create FormData object
            const formData = new FormData(this);

            // Add the combined datetime
            formData.set('due_date', `${date}T${time}`);

            // Send the form
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Handle redirect
                if (response.redirected) {
                    window.location.href = response.url;
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data === null) {
                    // Redirect was handled above
                    return;
                }
                if (data.status === 'success') {
                    showNotification('Task created successfully!', 'success');
                    closeCreateTaskModal();
                    window.location.reload();
                } else {
                    showNotification(data.message || 'Error creating task', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error creating task. Please try again.', 'error');
                window.location.reload(); // Reload on error to refresh the CSRF token
            });
        });
    });
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        } text-white`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
    }
    </script>

    <script>
        let currentTaskId = null;
    
        function openTaskDetail(taskId) {
            currentTaskId = taskId;
            const modal = document.getElementById('taskDetailModal');
            
            // Show loading state
            document.getElementById('detailTaskTitle').textContent = 'Loading...';
            modal.classList.remove('hidden');
    
            // Fetch task details
            fetch(`/task/${taskId}/detail/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json())
            .then(data => {
                // Update modal content
                document.getElementById('detailTaskTitle').textContent = data.title;
                document.getElementById('detailCreatorInitial').textContent = data.created_by.firstname[0];
                document.getElementById('detailCreatorName').textContent = 
                    `${data.created_by.firstname} ${data.created_by.lastname}`;
                document.getElementById('detailCreatedDate').textContent = 
                    new Date(data.created_date).toLocaleDateString();
                
                // Status badge
                const statusBadge = document.getElementById('detailStatus');
                statusBadge.textContent = data.status;
                statusBadge.className = `px-3 py-1 rounded-full text-sm ${
                    data.status === 'COMPLETED' ? 'bg-green-100 text-green-800' :
                    data.status === 'IN_PROGRESS' ? 'bg-blue-100 text-blue-800' :
                    data.status === 'CANCELLED' ? 'bg-gray-100 text-gray-800' :
                    'bg-yellow-100 text-yellow-800'
                }`;
    
                // Priority badge
                const priorityBadge = document.getElementById('detailPriority');
                priorityBadge.textContent = data.priority;
                priorityBadge.className = `px-3 py-1 rounded-full text-sm ${
                    data.priority === 'HIGH' ? 'bg-red-100 text-red-800' :
                    data.priority === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-green-100 text-green-800'
                }`;
    
                document.getElementById('detailDescription').textContent = data.description;
                document.getElementById('detailDueDate').textContent = 
                    new Date(data.due_date).toLocaleString();
    
                // Handle event-specific details
                const eventSection = document.getElementById('detailEventSection');
                const eventButtons = document.getElementById('detailEventButtons');
                if (data.is_event) {
                    document.getElementById('detailLocation').textContent = data.location || 'No location specified';
                    document.getElementById('detailParticipants').textContent = 
                        `${data.participants_count} participants ${data.max_participants > 0 ? 
                        '/ ' + data.max_participants + ' max' : ''}`;
                    eventSection.classList.remove('hidden');
                    
                    // Update event buttons with disabled state handling
                    eventButtons.classList.remove('hidden');
                    const buttonHtml = data.is_participant ?
                        `<button onclick="leaveTask(${taskId})" 
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            id="eventActionButton">
                            Leave Event
                        </button>` :
                        `<button onclick="joinTask(${taskId})"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            id="eventActionButton"
                            ${data.max_participants > 0 && data.participants_count >= data.max_participants ? 'disabled' : ''}>
                            Join Event
                        </button>`;
                    eventButtons.innerHTML = buttonHtml;
                } else {
                    eventSection.classList.add('hidden');
                    eventButtons.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading task details', 'error');
                closeTaskDetailModal();
            });
        }
    
        function closeTaskDetailModal() {
            document.getElementById('taskDetailModal').classList.add('hidden');
            currentTaskId = null;
        }
    
        // Close modal when clicking outside
        document.getElementById('taskDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskDetailModal();
            }
        });
    </script>
    <script>
        function joinTask(taskId) {
            const isInModal = !document.getElementById('taskDetailModal').classList.contains('hidden');
            
            fetch(`/task/${taskId}/join/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Successfully joined the event!', 'success');
                    // Wait 2 seconds before reloading
                    setTimeout(() => {
                        if (isInModal) {
                            openTaskDetail(taskId);
                        } else {
                            window.location.reload();
                        }
                    }, 500); // 2 second delay
                } else {
                    showNotification(data.message || 'Error joining event', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error joining event. Please try again.', 'error');
            });
        }
    
        function leaveTask(taskId) {
            const isInModal = !document.getElementById('taskDetailModal').classList.contains('hidden');
            const currentUrl = window.location.href;
            const isMyTasksView = currentUrl.includes('filter=assigned');
            
            fetch(`/task/${taskId}/leave/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    showNotification('Successfully left the event!', 'success');
                    setTimeout(() => {
                        window.location.href = '/task/?filter=assigned';
                    }, 2000); // 2 second delay
                    return { status: 'success' };
                }
            })
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Successfully left the event!', 'success');
                    // Wait 2 seconds before reloading
                    setTimeout(() => {
                        if (isInModal) {
                            openTaskDetail(taskId);
                        } else if (isMyTasksView) {
                            window.location.href = '/task/?filter=assigned';
                        } else {
                            window.location.reload();
                        }
                    }, 500); // 2 second delay
                } else {
                    showNotification(data.message || 'Error leaving event', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error leaving event. Please try again.', 'error');
                if (isMyTasksView) {
                    setTimeout(() => {
                        window.location.href = '/task/?filter=assigned';
                    }, 500); // 2 second delay
                }
            });
        }

        function toggleEventButtons(disabled = true) {
            const buttons = document.querySelectorAll('button[onclick*="joinTask"], button[onclick*="leaveTask"]');
            buttons.forEach(button => {
                button.disabled = disabled;
            });
        }
        </script>
        <script>
            // Add these functions to your script section
function editTask(taskId) {
    const title = prompt('Enter new title:');
    if (title === null) return;
    
    const description = prompt('Enter new description:');
    if (description === null) return;
    
    const reward_points = prompt('Enter reward points:', '0');
    if (reward_points === null) return;
    
    fetch(`/task/${taskId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            title: title,
            description: description,
            reward_points: parseInt(reward_points)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Task updated successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification('Error updating task', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating task', 'error');
    });
}

function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    fetch(`/task/${taskId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Task deleted successfully!', 'success');
            setTimeout(() => window.location.href = '/task/', 1000);
        } else {
            showNotification('Error deleting task', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting task', 'error');
    });
}
document.getElementById('detailRewardPoints').textContent = `${data.reward_points} points`;
        </script>

</body>
</html>